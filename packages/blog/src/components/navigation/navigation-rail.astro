---
import { routes } from "../../router/routes";
import NavigationRailSwitchThemeButton from "./navigation-rail-switch-theme-button.astro";
---

<div transition:persist="navigation-rail-component" class="navigation-rail">
    <div class="start"></div>
    <div class="tabs">
        {
            routes.map((link) => (
                <span class="navigation-rail-tab" data-href={link.url}>
                    <span class="indicator">
                        <md-icon class="icon">{link.iconString}</md-icon>
                        <md-ripple class="ripple" />
                    </span>
                    <span class="label md-typescale-label-medium">
                        {link.label}
                    </span>
                </span>
            ))
        }
    </div>
    <div class="end">
        <NavigationRailSwitchThemeButton />
    </div>
</div>

<script>
    import "@material/web/icon/icon";
    import "@material/web/ripple/ripple";
</script>

<script>
    import { MdRipple } from "@material/web/ripple/ripple";
    import { currentRouteUrl } from "@router/routes";
    import { navigate } from "astro:transitions/client";

    const rail = document.querySelector(".navigation-rail")! as HTMLElement;
    const tabContainer = rail.querySelector("&>.tabs")! as HTMLElement;
    const tabs = Array.from(
        tabContainer.querySelectorAll(
            "&>.navigation-rail-tab",
        ) as NodeListOf<HTMLElement>,
    );

    document.addEventListener("astro:page-load", (_) => {
        /**
         * @event click 為navigation-rail中的navigation-rail-tab設置頁面導行, 同時激活對應的navigation-rail-tab
         */
        tabs.forEach((item) => {
            item.addEventListener("click", (e) => {
                navigate(
                    (e.target as HTMLElement).getAttribute("data-href")!,
                ).then(() => {
                    tabs.forEach((tab) => {
                        if (tab.classList.contains("active")) {
                            tab.classList.remove("active");
                        }
                    });
                    (e.target as HTMLElement).classList.add("active");
                    currentRouteUrl.set(
                        (e.target as HTMLElement).getAttribute("data-href")!,
                    );
                });
            });
        });

        /**
         * @event load 初始化navigation-rail默認激活的navigation-rail-tab
         */
        if (
            tabs.findIndex((tab: HTMLElement) =>
                tab.classList.contains("active"),
            ) === -1
        ) {
            const url = new URL(window.location.href);
            tabs.forEach((tab) => {
                if (tab.getAttribute("data-href")! === url.pathname) {
                    tab.classList.add("active");
                }
            });
        }

        tabs.map((item: Element) => {
            const ripple = item.querySelector("&>.indicator>.ripple");
            (ripple as MdRipple).attach(item as HTMLElement);
        });
    });

    currentRouteUrl.subscribe((value) => {
        tabs.forEach((tab) => {
            if (tab.classList.contains("active")) {
                tab.classList.remove("active");
            }
        });
        tabs.forEach((tab) => {
            if (tab.getAttribute("data-href") === value) {
                tab.classList.add("active");
            }
        });
    });
</script>

<style>
    .navigation-rail {
        width: 84px;
        height: 100%;
        background-color: var(--md-sys-color-surface-container);
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 24px 0px;
        overflow: hidden;
        row-gap: 24px;

        @media (min-width: 600px) and (max-width: 840px) {
            & > .tabs {
                justify-content: center;
            }
        }

        & > .start {
            display: grid;
            place-content: center;
        }

        & > .tabs {
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex-grow: 1;
            overflow: auto;
            user-select: none;

            & > .navigation-rail-tab {
                --container-height: 56px;
                --container-width: 80px;
                --indicator-height: 32px;
                --indicator-width: 56px;

                display: flex;
                align-items: center;
                flex-direction: column;
                gap: 8px;
                height: var(--container-height);
                position: relative;
                cursor: pointer;

                & > * {
                    pointer-events: none;
                }

                & > .indicator {
                    height: var(--indicator-height);
                    width: var(--indicator-width);
                    border-radius: 16px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    overflow: hidden;
                    position: relative;

                    &::after {
                        content: "";
                        display: block;
                        height: 100%;
                        width: 100%;
                        position: absolute;
                        inset: 0;
                    }

                    & > .icon {
                        z-index: 1;
                        color: var(--md-sys-color-on-surface);
                    }

                    &::after,
                    & > .icon {
                        transition-property: background-color, color,
                            font-variation-settings, width;
                        transition-duration: 100ms;
                    }
                }
                & > .label {
                    display: block;
                    text-align: center;
                    color: var(--md-sys-color-on-surface);
                }

                &.active {
                    .indicator > .icon {
                        font-variation-settings:
                            "FILL" 1,
                            "wght" 400,
                            "GRAD" 0,
                            "opsz" 24;
                        color: var(--md-sys-color-on-secondary-container);
                        fill: var(--md-sys-color-on-secondary-container);
                    }
                    .indicator::after {
                        width: 100%;
                        background-color: var(
                            --md-sys-color-secondary-container
                        );
                    }
                }
            }
        }
    }
</style>
